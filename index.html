<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>form1 - 訂餐表單</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 20px;
            background-color: #f9f9f9;
            color: #333;
            touch-action: pan-y;
        }
        
        .form-container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .image-preview {
            margin-bottom: 25px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: #f8f9fa;
        }
        
        .image-container {
            position: relative;
            width: 100%;
            height: 250px;
            overflow: hidden;
            touch-action: none;
        }
        
        #zoomImage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(1);
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transform-origin: center center;
            user-select: none;
            -webkit-user-drag: none;
            will-change: transform;
            display: block;
        }
        
        .image-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
            font-size: 14px;
        }
        
        .zoom-info { color: #666; }
        
        .reset-btn {
            background: white;
            border: 1px solid #3498db;
            color: #3498db;
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }
        
        .form-subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 25px;
            font-size: 1rem;
        }
        
        .form-group { margin-bottom: 20px; }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        input[type="text"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        
        .required::after {
            content: " *";
            color: #e74c3c;
        }
        
        .submit-btn {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 15px;
            width: 100%;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        
        .submit-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .submit-btn.success {
            background-color: #27ae60;
            animation: buttonSuccess 1s forwards;
        }
        
        @keyframes buttonSuccess {
            0% { background-color: #2ecc71; }
            20% { background-color: #27ae60; }
            80% { background-color: #27ae60; }
            100% { background-color: #2ecc71; }
        }
        
        .back-link {
            display: block;
            text-align: center;
            margin-top: 20px;
            color: #3498db;
            text-decoration: none;
        }
        
        .message {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h1>form1 - 永樂燒肉飯</h1>
        <div class="form-subtitle">請填寫以下資訊以完成訂餐</div>
        
        <div id="message" class="message"></div>
        
        <form id="orderForm">
            <div class="form-group">
                <label for="name" class="required">座號</label>
                <input type="text" id="name" name="name" required placeholder="其他班寫名字或班級座號">
            </div>
            
            <div class="image-preview">
                <div class="image-container" id="imageContainer">
                    <img src="https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=800&auto=format&fit=crop" 
                         alt="本週餐點預覽" 
                         id="zoomImage"
                         draggable="false">
                </div>
                <div class="image-controls">
                    <div class="zoom-info">縮放: <span id="zoomPercent">100%</span></div>
                    <button type="button" class="reset-btn" id="resetZoom">重置</button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="drink" class="required">湯或飲料</label>
                <select id="drink" name="drink" required>
                    <option value="">請選擇湯或紅茶</option>
                    <option value="corn">玉米濃湯</option>
                    <option value="blacktea">紅茶</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="required">吃什麼</label>
                <div style="margin-top: 10px;">
                    <label style="display: block; margin-bottom: 10px;">
                        <input type="radio" name="mainCourse" value="steak" required style="margin-right: 10px;">
                        牛排
                    </label>
                    <label style="display: block; margin-bottom: 10px;">
                        <input type="radio" name="mainCourse" value="pork" style="margin-right: 10px;">
                        蒜香豬排飯 $110
                    </label>
                    <label style="display: block;">
                        <input type="radio" name="mainCourse" value="fish" style="margin-right: 10px;">
                        檸檬魚排飯 $130
                    </label>
                </div>
            </div>
            
            <div class="form-group">
                <label for="sauce" class="required">醬汁</label>
                <select id="sauce" name="sauce" required>
                    <option value="">選擇醬汁</option>
                    <option value="onion">洋蔥</option>
                    <option value="pepper">黑胡椒</option>
                    <option value="mix">綜合</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="notes">加點區</label>
                <textarea id="notes" name="notes" rows="3" placeholder="例如：不要蔥薑蒜、辣度調整等"></textarea>
            </div>
            
            <button type="submit" class="submit-btn" id="submitBtn">
                <span id="btnText">提交訂單</span>
                <span id="btnLoading" style="display: none;">處理中...</span>
            </button>
        </form>
        
        <a href="index.html" class="back-link">← 返回主網站</a>
    </div>

    <script>
        // =========== 簡化 Supabase 初始化 ===========
        const SUPABASE_URL = 'https://aaasogfgpumkepbklrhl.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_uAxCjm27kizI4dAZUdpceQ_8gcxBtLa';
        
        // 快速初始化
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: { persistSession: false }
        });

        // =========== 表單提交功能 ===========
        document.getElementById('orderForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            const btnLoading = document.getElementById('btnLoading');
            
            // 顯示載入狀態
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline';
            
            try {
                // 收集表單資料
                const name = document.getElementById('name').value.trim();
                const drink = document.getElementById('drink').value;
                const mainCourse = document.querySelector('input[name="mainCourse"]:checked')?.value;
                const sauce = document.getElementById('sauce').value;
                const notes = document.getElementById('notes').value.trim();
                
                // 驗證必填欄位
                if (!name) throw new Error('請填寫座號或姓名');
                if (!drink) throw new Error('請選擇湯或飲料');
                if (!mainCourse) throw new Error('請選擇主餐');
                if (!sauce) throw new Error('請選擇醬汁');
                
                // 準備插入資料
                const orderData = {
                    seat: name,
                    drink: drink,
                    main: mainCourse,
                    sauce: sauce,
                    notes: notes || '無',
                    created_at: new Date().toISOString()
                };
                
                // 提交到 f1_order 表格
                const { error } = await db
                    .from('f1_order')
                    .insert([orderData]);
                
                if (error) throw new Error(`提交失敗: ${error.message}`);
                
                // 提交成功 - 在按鈕上顯示成功
                submitBtn.classList.add('success');
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
                btnText.textContent = '提交成功！';
                
                // 1秒後重置表單和按鈕
                setTimeout(() => {
                    this.reset();
                    submitBtn.classList.remove('success');
                    btnText.textContent = '提交訂單';
                    submitBtn.disabled = false;
                }, 1000);
                
            } catch (error) {
                // 顯示錯誤訊息
                const messageDiv = document.getElementById('message');
                messageDiv.className = 'message error';
                messageDiv.textContent = `❌ ${error.message}`;
                messageDiv.style.display = 'block';
                
                // 恢復按鈕狀態
                submitBtn.disabled = false;
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
                
                // 5秒後隱藏錯誤訊息
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 5000);
            }
        });
        
        // =========== 恢復原本的圖片縮放功能 ===========
        const image = document.getElementById('zoomImage');
        const zoomPercent = document.getElementById('zoomPercent');
        const resetBtn = document.getElementById('resetZoom');
        const container = document.getElementById('imageContainer');
        
        let scale = 1;
        let isDragging = false;
        let startX = 0, startY = 0;
        let translateX = 0, translateY = 0;
        
        // 重置圖片
        function resetImage() {
            scale = 1;
            translateX = 0;
            translateY = 0;
            updateImage();
        }
        
        // 更新圖片變換
        function updateImage() {
            image.style.transform = `translate(-50%, -50%) translate(${translateX}px, ${translateY}px) scale(${scale})`;
            zoomPercent.textContent = Math.round(scale * 100) + '%';
        }
        
        // 重置按鈕
        if (resetBtn) {
            resetBtn.addEventListener('click', resetImage);
        }
        
        // 滑鼠事件
        container.addEventListener('mousedown', (e) => {
            if (scale <= 1) return;
            e.preventDefault();
            isDragging = true;
            startX = e.clientX - translateX;
            startY = e.clientY - translateY;
            image.style.cursor = 'grabbing';
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            translateX = e.clientX - startX;
            translateY = e.clientY - startY;
            updateImage();
        });
        
        document.addEventListener('mouseup', () => {
            isDragging = false;
            image.style.cursor = 'grab';
        });
        
        // 滾輪縮放（恢復原本的中心點縮放）
        container.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            scale = Math.max(1, Math.min(5, scale + delta));
            updateImage();
        }, { passive: false });
        
        // 觸控縮放
        let initialDistance = 0;
        
        container.addEventListener('touchstart', (e) => {
            if (e.touches.length === 2) {
                e.preventDefault();
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                initialDistance = Math.sqrt(dx * dx + dy * dy);
            } else if (e.touches.length === 1 && scale > 1) {
                e.preventDefault();
                isDragging = true;
                startX = e.touches[0].clientX - translateX;
                startY = e.touches[0].clientY - translateY;
            }
        }, { passive: false });
        
        container.addEventListener('touchmove', (e) => {
            if (e.touches.length === 2) {
                e.preventDefault();
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (initialDistance > 0) {
                    const delta = (distance - initialDistance) * 0.01;
                    scale = Math.max(1, Math.min(5, scale + delta));
                    updateImage();
                    initialDistance = distance;
                }
            } else if (e.touches.length === 1 && isDragging) {
                e.preventDefault();
                translateX = e.touches[0].clientX - startX;
                translateY = e.touches[0].clientY - startY;
                updateImage();
            }
        }, { passive: false });
        
        container.addEventListener('touchend', () => {
            isDragging = false;
            initialDistance = 0;
        });
        
        // 初始化圖片
        window.addEventListener('load', () => {
            resetImage();
        });
    </script>
</body>
</html>